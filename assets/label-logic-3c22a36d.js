(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const o of i)if(o.type==="childList")for(const r of o.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&s(r)}).observe(document,{childList:!0,subtree:!0});function n(i){const o={};return i.integrity&&(o.integrity=i.integrity),i.referrerPolicy&&(o.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?o.credentials="include":i.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function s(i){if(i.ep)return;i.ep=!0;const o=n(i);fetch(i.href,o)}})();var M=globalThis&&globalThis.__awaiter||function(t,e,n,s){function i(o){return o instanceof n?o:new n(function(r){r(o)})}return new(n||(n=Promise))(function(o,r){function a(c){try{u(s.next(c))}catch(d){r(d)}}function l(c){try{u(s.throw(c))}catch(d){r(d)}}function u(c){c.done?o(c.value):i(c.value).then(a,l)}u((s=s.apply(t,e||[])).next())})};class wt{constructor(e){this.messageBus=e}get id(){if(!this.messageBus.userId)throw Error("Unable to get user ID: not ready");return this.messageBus.userId}getSelection(){return M(this,void 0,void 0,function*(){const{selection:e}=yield this.messageBus.sendAsync("OBR_PLAYER_GET_SELECTION",{});return e})}select(e,n){return M(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_PLAYER_SELECT",{items:e,replace:n})})}deselect(e){return M(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_PLAYER_DESELECT",{items:e})})}getName(){return M(this,void 0,void 0,function*(){const{name:e}=yield this.messageBus.sendAsync("OBR_PLAYER_GET_NAME",{});return e})}setName(e){return M(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_PLAYER_SET_NAME",{name:e})})}getColor(){return M(this,void 0,void 0,function*(){const{color:e}=yield this.messageBus.sendAsync("OBR_PLAYER_GET_COLOR",{});return e})}setColor(e){return M(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_PLAYER_SET_COLOR",{color:e})})}getSyncView(){return M(this,void 0,void 0,function*(){const{syncView:e}=yield this.messageBus.sendAsync("OBR_PLAYER_GET_SYNC_VIEW",{});return e})}setSyncView(e){return M(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_PLAYER_SET_SYNC_VIEW",{syncView:e})})}getId(){return M(this,void 0,void 0,function*(){const{id:e}=yield this.messageBus.sendAsync("OBR_PLAYER_GET_ID",{});return e})}getRole(){return M(this,void 0,void 0,function*(){const{role:e}=yield this.messageBus.sendAsync("OBR_PLAYER_GET_ROLE",{});return e})}getMetadata(){return M(this,void 0,void 0,function*(){const{metadata:e}=yield this.messageBus.sendAsync("OBR_PLAYER_GET_METADATA",{});return e})}setMetadata(e){return M(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_PLAYER_SET_METADATA",{update:e})})}hasPermission(e){return M(this,void 0,void 0,function*(){if((yield this.getRole())==="GM")return!0;const{permissions:s}=yield this.messageBus.sendAsync("OBR_ROOM_GET_PERMISSIONS",{});return s.indexOf(e)>-1})}getConnectionId(){return M(this,void 0,void 0,function*(){const{connectionId:e}=yield this.messageBus.sendAsync("OBR_PLAYER_GET_CONNECTION_ID",{});return e})}onChange(e){const n=s=>{e(s.player)};return this.messageBus.send("OBR_PLAYER_SUBSCRIBE",{}),this.messageBus.on("OBR_PLAYER_EVENT_CHANGE",n),()=>{this.messageBus.send("OBR_PLAYER_UNSUBSCRIBE",{}),this.messageBus.off("OBR_PLAYER_EVENT_CHANGE",n)}}}var F=globalThis&&globalThis.__awaiter||function(t,e,n,s){function i(o){return o instanceof n?o:new n(function(r){r(o)})}return new(n||(n=Promise))(function(o,r){function a(c){try{u(s.next(c))}catch(d){r(d)}}function l(c){try{u(s.throw(c))}catch(d){r(d)}}function u(c){c.done?o(c.value):i(c.value).then(a,l)}u((s=s.apply(t,e||[])).next())})};class xt{constructor(e){this.messageBus=e}reset(){return F(this,void 0,void 0,function*(){const{transform:e}=yield this.messageBus.sendAsync("OBR_VIEWPORT_RESET",{});return e})}animateTo(e){return F(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_VIEWPORT_ANIMATE_TO",{transform:e})})}animateToBounds(e){return F(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_VIEWPORT_ANIMATE_TO_BOUNDS",{bounds:e})})}getPosition(){return F(this,void 0,void 0,function*(){const{position:e}=yield this.messageBus.sendAsync("OBR_VIEWPORT_GET_POSITION",{});return e})}setPosition(e){return F(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_VIEWPORT_SET_POSITION",{position:e})})}getScale(){return F(this,void 0,void 0,function*(){const{scale:e}=yield this.messageBus.sendAsync("OBR_VIEWPORT_GET_SCALE",{});return e})}setScale(e){return F(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_VIEWPORT_SET_SCALE",{scale:e})})}getWidth(){return F(this,void 0,void 0,function*(){const{width:e}=yield this.messageBus.sendAsync("OBR_VIEWPORT_GET_WIDTH",{});return e})}getHeight(){return F(this,void 0,void 0,function*(){const{height:e}=yield this.messageBus.sendAsync("OBR_VIEWPORT_GET_HEIGHT",{});return e})}transformPoint(e){return F(this,void 0,void 0,function*(){const{point:n}=yield this.messageBus.sendAsync("OBR_VIEWPORT_TRANSFORM_POINT",{point:e});return n})}inverseTransformPoint(e){return F(this,void 0,void 0,function*(){const{point:n}=yield this.messageBus.sendAsync("OBR_VIEWPORT_INVERSE_TRANSFORM_POINT",{point:e});return n})}}function Lt(t){return typeof t.id=="string"}var Ue={exports:{}},oe=typeof Reflect=="object"?Reflect:null,Ke=oe&&typeof oe.apply=="function"?oe.apply:function(e,n,s){return Function.prototype.apply.call(e,n,s)},pe;oe&&typeof oe.ownKeys=="function"?pe=oe.ownKeys:Object.getOwnPropertySymbols?pe=function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:pe=function(e){return Object.getOwnPropertyNames(e)};function Mt(t){console&&console.warn&&console.warn(t)}var ct=Number.isNaN||function(e){return e!==e};function B(){B.init.call(this)}Ue.exports=B;Ue.exports.once=Pt;B.EventEmitter=B;B.prototype._events=void 0;B.prototype._eventsCount=0;B.prototype._maxListeners=void 0;var Xe=10;function Be(t){if(typeof t!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof t)}Object.defineProperty(B,"defaultMaxListeners",{enumerable:!0,get:function(){return Xe},set:function(t){if(typeof t!="number"||t<0||ct(t))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+t+".");Xe=t}});B.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0};B.prototype.setMaxListeners=function(e){if(typeof e!="number"||e<0||ct(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this};function at(t){return t._maxListeners===void 0?B.defaultMaxListeners:t._maxListeners}B.prototype.getMaxListeners=function(){return at(this)};B.prototype.emit=function(e){for(var n=[],s=1;s<arguments.length;s++)n.push(arguments[s]);var i=e==="error",o=this._events;if(o!==void 0)i=i&&o.error===void 0;else if(!i)return!1;if(i){var r;if(n.length>0&&(r=n[0]),r instanceof Error)throw r;var a=new Error("Unhandled error."+(r?" ("+r.message+")":""));throw a.context=r,a}var l=o[e];if(l===void 0)return!1;if(typeof l=="function")Ke(l,this,n);else for(var u=l.length,c=ft(l,u),s=0;s<u;++s)Ke(c[s],this,n);return!0};function dt(t,e,n,s){var i,o,r;if(Be(n),o=t._events,o===void 0?(o=t._events=Object.create(null),t._eventsCount=0):(o.newListener!==void 0&&(t.emit("newListener",e,n.listener?n.listener:n),o=t._events),r=o[e]),r===void 0)r=o[e]=n,++t._eventsCount;else if(typeof r=="function"?r=o[e]=s?[n,r]:[r,n]:s?r.unshift(n):r.push(n),i=at(t),i>0&&r.length>i&&!r.warned){r.warned=!0;var a=new Error("Possible EventEmitter memory leak detected. "+r.length+" "+String(e)+" listeners added. Use emitter.setMaxListeners() to increase limit");a.name="MaxListenersExceededWarning",a.emitter=t,a.type=e,a.count=r.length,Mt(a)}return t}B.prototype.addListener=function(e,n){return dt(this,e,n,!1)};B.prototype.on=B.prototype.addListener;B.prototype.prependListener=function(e,n){return dt(this,e,n,!0)};function Dt(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function ut(t,e,n){var s={fired:!1,wrapFn:void 0,target:t,type:e,listener:n},i=Dt.bind(s);return i.listener=n,s.wrapFn=i,i}B.prototype.once=function(e,n){return Be(n),this.on(e,ut(this,e,n)),this};B.prototype.prependOnceListener=function(e,n){return Be(n),this.prependListener(e,ut(this,e,n)),this};B.prototype.removeListener=function(e,n){var s,i,o,r,a;if(Be(n),i=this._events,i===void 0)return this;if(s=i[e],s===void 0)return this;if(s===n||s.listener===n)--this._eventsCount===0?this._events=Object.create(null):(delete i[e],i.removeListener&&this.emit("removeListener",e,s.listener||n));else if(typeof s!="function"){for(o=-1,r=s.length-1;r>=0;r--)if(s[r]===n||s[r].listener===n){a=s[r].listener,o=r;break}if(o<0)return this;o===0?s.shift():bt(s,o),s.length===1&&(i[e]=s[0]),i.removeListener!==void 0&&this.emit("removeListener",e,a||n)}return this};B.prototype.off=B.prototype.removeListener;B.prototype.removeAllListeners=function(e){var n,s,i;if(s=this._events,s===void 0)return this;if(s.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):s[e]!==void 0&&(--this._eventsCount===0?this._events=Object.create(null):delete s[e]),this;if(arguments.length===0){var o=Object.keys(s),r;for(i=0;i<o.length;++i)r=o[i],r!=="removeListener"&&this.removeAllListeners(r);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(n=s[e],typeof n=="function")this.removeListener(e,n);else if(n!==void 0)for(i=n.length-1;i>=0;i--)this.removeListener(e,n[i]);return this};function lt(t,e,n){var s=t._events;if(s===void 0)return[];var i=s[e];return i===void 0?[]:typeof i=="function"?n?[i.listener||i]:[i]:n?Gt(i):ft(i,i.length)}B.prototype.listeners=function(e){return lt(this,e,!0)};B.prototype.rawListeners=function(e){return lt(this,e,!1)};B.listenerCount=function(t,e){return typeof t.listenerCount=="function"?t.listenerCount(e):ht.call(t,e)};B.prototype.listenerCount=ht;function ht(t){var e=this._events;if(e!==void 0){var n=e[t];if(typeof n=="function")return 1;if(n!==void 0)return n.length}return 0}B.prototype.eventNames=function(){return this._eventsCount>0?pe(this._events):[]};function ft(t,e){for(var n=new Array(e),s=0;s<e;++s)n[s]=t[s];return n}function bt(t,e){for(;e+1<t.length;e++)t[e]=t[e+1];t.pop()}function Gt(t){for(var e=new Array(t.length),n=0;n<e.length;++n)e[n]=t[n].listener||t[n];return e}function Pt(t,e){return new Promise(function(n,s){function i(r){t.removeListener(e,o),s(r)}function o(){typeof t.removeListener=="function"&&t.removeListener("error",i),n([].slice.call(arguments))}_t(t,e,o,{once:!0}),e!=="error"&&Ut(t,i,{once:!0})})}function Ut(t,e,n){typeof t.on=="function"&&_t(t,"error",e,n)}function _t(t,e,n,s){if(typeof t.on=="function")s.once?t.once(e,n):t.on(e,n);else if(typeof t.addEventListener=="function")t.addEventListener(e,function i(o){s.once&&t.removeEventListener(e,i),n(o)});else throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof t)}var Vt=Ue.exports;let ye;const kt=new Uint8Array(16);function Ht(){if(!ye&&(ye=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!ye))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return ye(kt)}const w=[];for(let t=0;t<256;++t)w.push((t+256).toString(16).slice(1));function Ft(t,e=0){return w[t[e+0]]+w[t[e+1]]+w[t[e+2]]+w[t[e+3]]+"-"+w[t[e+4]]+w[t[e+5]]+"-"+w[t[e+6]]+w[t[e+7]]+"-"+w[t[e+8]]+w[t[e+9]]+"-"+w[t[e+10]]+w[t[e+11]]+w[t[e+12]]+w[t[e+13]]+w[t[e+14]]+w[t[e+15]]}const Wt=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),Qe={randomUUID:Wt};function Et(t,e,n){if(Qe.randomUUID&&!e&&!t)return Qe.randomUUID();t=t||{};const s=t.random||(t.rng||Ht)();if(s[6]=s[6]&15|64,s[8]=s[8]&63|128,e){n=n||0;for(let i=0;i<16;++i)e[n+i]=s[i];return e}return Ft(s)}class $t extends Vt.EventEmitter{constructor(e,n){super(),this.ready=!1,this.userId=null,this.ref=null,this.handleMessage=s=>{const i=s.data;if(s.origin===this.targetOrigin&&Lt(i)){if(i.id==="OBR_READY"){this.ready=!0;const o=i.data;this.ref=o.ref,this.userId=o.userId}this.emit(i.id,i.data)}},this.send=(s,i,o)=>{var r;if(!this.ref)throw Error("Unable to send message: not ready");(r=window.parent)===null||r===void 0||r.postMessage({id:s,data:i,ref:this.ref,nonce:o},this.targetOrigin)},this.sendAsync=(s,i,o=5e3)=>{const r=`_${Et()}`;return this.send(s,i,r),Promise.race([new Promise((a,l)=>{const u=this;function c(_){u.off(`${s}_RESPONSE${r}`,c),u.off(`${s}_ERROR${r}`,d),a(_)}function d(_){u.off(`${s}_RESPONSE${r}`,c),u.off(`${s}_ERROR${r}`,d),l(_)}this.on(`${s}_RESPONSE${r}`,c),this.on(`${s}_ERROR${r}`,d)}),...o>0?[new Promise((a,l)=>window.setTimeout(()=>l(new Error(`Message ${s} took longer than ${o}ms to get a result`)),o))]:[]])},this.roomId=n,this.targetOrigin=e,window.addEventListener("message",this.handleMessage),this.setMaxListeners(100)}destroy(){window.removeEventListener("message",this.handleMessage)}}var Ze=globalThis&&globalThis.__awaiter||function(t,e,n,s){function i(o){return o instanceof n?o:new n(function(r){r(o)})}return new(n||(n=Promise))(function(o,r){function a(c){try{u(s.next(c))}catch(d){r(d)}}function l(c){try{u(s.throw(c))}catch(d){r(d)}}function u(c){c.done?o(c.value):i(c.value).then(a,l)}u((s=s.apply(t,e||[])).next())})};class Yt{constructor(e){this.messageBus=e}show(e,n){return Ze(this,void 0,void 0,function*(){const{id:s}=yield this.messageBus.sendAsync("OBR_NOTIFICATION_SHOW",{message:e,variant:n});return s})}close(e){return Ze(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_NOTIFICATION_CLOSE",{id:e})})}}var te=globalThis&&globalThis.__awaiter||function(t,e,n,s){function i(o){return o instanceof n?o:new n(function(r){r(o)})}return new(n||(n=Promise))(function(o,r){function a(c){try{u(s.next(c))}catch(d){r(d)}}function l(c){try{u(s.throw(c))}catch(d){r(d)}}function u(c){c.done?o(c.value):i(c.value).then(a,l)}u((s=s.apply(t,e||[])).next())})};class zt{constructor(e){this.messageBus=e}getColor(){return te(this,void 0,void 0,function*(){const{color:e}=yield this.messageBus.sendAsync("OBR_SCENE_FOG_GET_COLOR",{});return e})}setColor(e){return te(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_SCENE_FOG_SET_COLOR",{color:e})})}getStrokeWidth(){return te(this,void 0,void 0,function*(){const{strokeWidth:e}=yield this.messageBus.sendAsync("OBR_SCENE_FOG_GET_STROKE_WIDTH",{});return e})}setStrokeWidth(e){return te(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_SCENE_FOG_SET_STROKE_WIDTH",{strokeWidth:e})})}getFilled(){return te(this,void 0,void 0,function*(){const{filled:e}=yield this.messageBus.sendAsync("OBR_SCENE_FOG_GET_FILLED",{});return e})}setFilled(e){return te(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_SCENE_FOG_SET_FILLED",{filled:e})})}onChange(e){const n=s=>{e(s.fog)};return this.messageBus.send("OBR_SCENE_FOG_SUBSCRIBE",{}),this.messageBus.on("OBR_SCENE_FOG_EVENT_CHANGE",n),()=>{this.messageBus.send("OBR_SCENE_FOG_UNSUBSCRIBE",{}),this.messageBus.off("OBR_SCENE_FOG_EVENT_CHANGE",n)}}}var D=globalThis&&globalThis.__awaiter||function(t,e,n,s){function i(o){return o instanceof n?o:new n(function(r){r(o)})}return new(n||(n=Promise))(function(o,r){function a(c){try{u(s.next(c))}catch(d){r(d)}}function l(c){try{u(s.throw(c))}catch(d){r(d)}}function u(c){c.done?o(c.value):i(c.value).then(a,l)}u((s=s.apply(t,e||[])).next())})};class jt{constructor(e){this.messageBus=e}getDpi(){return D(this,void 0,void 0,function*(){const{dpi:e}=yield this.messageBus.sendAsync("OBR_SCENE_GRID_GET_DPI",{});return e})}getScale(){return D(this,void 0,void 0,function*(){return yield this.messageBus.sendAsync("OBR_SCENE_GRID_GET_SCALE",{})})}setScale(e){return D(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_SCENE_GRID_SET_SCALE",{scale:e})})}getColor(){return D(this,void 0,void 0,function*(){const{color:e}=yield this.messageBus.sendAsync("OBR_SCENE_GRID_GET_COLOR",{});return e})}setColor(e){return D(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_SCENE_GRID_SET_COLOR",{color:e})})}getOpacity(){return D(this,void 0,void 0,function*(){const{opacity:e}=yield this.messageBus.sendAsync("OBR_SCENE_GRID_GET_OPACITY",{});return e})}setOpacity(e){return D(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_SCENE_GRID_SET_OPACITY",{opacity:e})})}getType(){return D(this,void 0,void 0,function*(){const{type:e}=yield this.messageBus.sendAsync("OBR_SCENE_GRID_GET_TYPE",{});return e})}setType(e){return D(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_SCENE_GRID_SET_TYPE",{type:e})})}getLineType(){return D(this,void 0,void 0,function*(){const{lineType:e}=yield this.messageBus.sendAsync("OBR_SCENE_GRID_GET_LINE_TYPE",{});return e})}setLineType(e){return D(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_SCENE_GRID_SET_LINE_TYPE",{lineType:e})})}getMeasurement(){return D(this,void 0,void 0,function*(){const{measurement:e}=yield this.messageBus.sendAsync("OBR_SCENE_GRID_GET_MEASUREMENT",{});return e})}setMeasurement(e){return D(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_SCENE_GRID_SET_MEASUREMENT",{measurement:e})})}snapPosition(e,n,s,i){return D(this,void 0,void 0,function*(){const{position:o}=yield this.messageBus.sendAsync("OBR_SCENE_GRID_SNAP_POSITION",{position:e,snappingSensitivity:n,useCorners:s,useCenter:i});return o})}getDistance(e,n){return D(this,void 0,void 0,function*(){const{distance:s}=yield this.messageBus.sendAsync("OBR_SCENE_GRID_GET_DISTANCE",{from:e,to:n});return s})}onChange(e){const n=s=>{e(s.grid)};return this.messageBus.send("OBR_SCENE_GRID_SUBSCRIBE",{}),this.messageBus.on("OBR_SCENE_GRID_EVENT_CHANGE",n),()=>{this.messageBus.send("OBR_SCENE_GRID_UNSUBSCRIBE",{}),this.messageBus.off("OBR_SCENE_GRID_EVENT_CHANGE",n)}}}var Oe=globalThis&&globalThis.__awaiter||function(t,e,n,s){function i(o){return o instanceof n?o:new n(function(r){r(o)})}return new(n||(n=Promise))(function(o,r){function a(c){try{u(s.next(c))}catch(d){r(d)}}function l(c){try{u(s.throw(c))}catch(d){r(d)}}function u(c){c.done?o(c.value):i(c.value).then(a,l)}u((s=s.apply(t,e||[])).next())})};class Kt{constructor(e){this.messageBus=e}undo(){return Oe(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_SCENE_HISTORY_UNDO",{})})}redo(){return Oe(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_SCENE_HISTORY_REDO",{})})}canUndo(){return Oe(this,void 0,void 0,function*(){const{canUndo:e}=yield this.messageBus.sendAsync("OBR_SCENE_HISTORY_CAN_UNDO",{});return e})}canRedo(){return Oe(this,void 0,void 0,function*(){const{canRedo:e}=yield this.messageBus.sendAsync("OBR_SCENE_HISTORY_CAN_REDO",{});return e})}}var Ve=Symbol.for("immer-nothing"),re=Symbol.for("immer-draftable"),U=Symbol.for("immer-state");function L(t,...e){throw new Error(`[Immer] minified error nr: ${t}. Full error at: https://bit.ly/3cXEKWf`)}var K=Object.getPrototypeOf;function X(t){return!!t&&!!t[U]}function Y(t){return t?yt(t)||Array.isArray(t)||!!t[re]||!!t.constructor?.[re]||he(t)||fe(t):!1}var Xt=Object.prototype.constructor.toString();function yt(t){if(!t||typeof t!="object")return!1;const e=K(t);if(e===null)return!0;const n=Object.hasOwnProperty.call(e,"constructor")&&e.constructor;return n===Object?!0:typeof n=="function"&&Function.toString.call(n)===Xt}function ae(t,e){Q(t)===0?Reflect.ownKeys(t).forEach(n=>{e(n,t[n],t)}):t.forEach((n,s)=>e(s,n,t))}function Q(t){const e=t[U];return e?e.type_:Array.isArray(t)?1:he(t)?2:fe(t)?3:0}function de(t,e){return Q(t)===2?t.has(e):Object.prototype.hasOwnProperty.call(t,e)}function ve(t,e){return Q(t)===2?t.get(e):t[e]}function Ot(t,e,n){const s=Q(t);s===2?t.set(e,n):s===3?t.add(n):t[e]=n}function Qt(t,e){return t===e?t!==0||1/t===1/e:t!==t&&e!==e}function he(t){return t instanceof Map}function fe(t){return t instanceof Set}function z(t){return t.copy_||t.base_}function we(t,e){if(he(t))return new Map(t);if(fe(t))return new Set(t);if(Array.isArray(t))return Array.prototype.slice.call(t);const n=yt(t);if(e===!0||e==="class_only"&&!n){const s=Object.getOwnPropertyDescriptors(t);delete s[U];let i=Reflect.ownKeys(s);for(let o=0;o<i.length;o++){const r=i[o],a=s[r];a.writable===!1&&(a.writable=!0,a.configurable=!0),(a.get||a.set)&&(s[r]={configurable:!0,writable:!0,enumerable:a.enumerable,value:t[r]})}return Object.create(K(t),s)}else{const s=K(t);if(s!==null&&n)return{...t};const i=Object.create(s);return Object.assign(i,t)}}function ke(t,e=!1){return Re(t)||X(t)||!Y(t)||(Q(t)>1&&(t.set=t.add=t.clear=t.delete=Zt),Object.freeze(t),e&&Object.entries(t).forEach(([n,s])=>ke(s,!0))),t}function Zt(){L(2)}function Re(t){return Object.isFrozen(t)}var xe={};function Z(t){const e=xe[t];return e||L(0,t),e}function Jt(t,e){xe[t]||(xe[t]=e)}var ue;function mt(){return ue}function qt(t,e){return{drafts_:[],parent_:t,immer_:e,canAutoFreeze_:!0,unfinalizedDrafts_:0}}function Je(t,e){e&&(Z("Patches"),t.patches_=[],t.inversePatches_=[],t.patchListener_=e)}function Le(t){Me(t),t.drafts_.forEach(en),t.drafts_=null}function Me(t){t===ue&&(ue=t.parent_)}function qe(t){return ue=qt(ue,t)}function en(t){const e=t[U];e.type_===0||e.type_===1?e.revoke_():e.revoked_=!0}function et(t,e){e.unfinalizedDrafts_=e.drafts_.length;const n=e.drafts_[0];return t!==void 0&&t!==n?(n[U].modified_&&(Le(e),L(4)),Y(t)&&(t=Ae(e,t),e.parent_||ge(e,t)),e.patches_&&Z("Patches").generateReplacementPatches_(n[U].base_,t,e.patches_,e.inversePatches_)):t=Ae(e,n,[]),Le(e),e.patches_&&e.patchListener_(e.patches_,e.inversePatches_),t!==Ve?t:void 0}function Ae(t,e,n){if(Re(e))return e;const s=e[U];if(!s)return ae(e,(i,o)=>tt(t,s,e,i,o,n)),e;if(s.scope_!==t)return e;if(!s.modified_)return ge(t,s.base_,!0),s.base_;if(!s.finalized_){s.finalized_=!0,s.scope_.unfinalizedDrafts_--;const i=s.copy_;let o=i,r=!1;s.type_===3&&(o=new Set(i),i.clear(),r=!0),ae(o,(a,l)=>tt(t,s,i,a,l,n,r)),ge(t,i,!1),n&&t.patches_&&Z("Patches").generatePatches_(s,n,t.patches_,t.inversePatches_)}return s.copy_}function tt(t,e,n,s,i,o,r){if(X(i)){const a=o&&e&&e.type_!==3&&!de(e.assigned_,s)?o.concat(s):void 0,l=Ae(t,i,a);if(Ot(n,s,l),X(l))t.canAutoFreeze_=!1;else return}else r&&n.add(i);if(Y(i)&&!Re(i)){if(!t.immer_.autoFreeze_&&t.unfinalizedDrafts_<1)return;Ae(t,i),(!e||!e.scope_.parent_)&&typeof s!="symbol"&&Object.prototype.propertyIsEnumerable.call(n,s)&&ge(t,i)}}function ge(t,e,n=!1){!t.parent_&&t.immer_.autoFreeze_&&t.canAutoFreeze_&&ke(e,n)}function tn(t,e){const n=Array.isArray(t),s={type_:n?1:0,scope_:e?e.scope_:mt(),modified_:!1,finalized_:!1,assigned_:{},parent_:e,base_:t,draft_:null,copy_:null,revoke_:null,isManual_:!1};let i=s,o=He;n&&(i=[s],o=le);const{revoke:r,proxy:a}=Proxy.revocable(i,o);return s.draft_=a,s.revoke_=r,a}var He={get(t,e){if(e===U)return t;const n=z(t);if(!de(n,e))return nn(t,n,e);const s=n[e];return t.finalized_||!Y(s)?s:s===Ce(t.base_,e)?(Ie(t),t.copy_[e]=be(s,t)):s},has(t,e){return e in z(t)},ownKeys(t){return Reflect.ownKeys(z(t))},set(t,e,n){const s=Tt(z(t),e);if(s?.set)return s.set.call(t.draft_,n),!0;if(!t.modified_){const i=Ce(z(t),e),o=i?.[U];if(o&&o.base_===n)return t.copy_[e]=n,t.assigned_[e]=!1,!0;if(Qt(n,i)&&(n!==void 0||de(t.base_,e)))return!0;Ie(t),De(t)}return t.copy_[e]===n&&(n!==void 0||e in t.copy_)||Number.isNaN(n)&&Number.isNaN(t.copy_[e])||(t.copy_[e]=n,t.assigned_[e]=!0),!0},deleteProperty(t,e){return Ce(t.base_,e)!==void 0||e in t.base_?(t.assigned_[e]=!1,Ie(t),De(t)):delete t.assigned_[e],t.copy_&&delete t.copy_[e],!0},getOwnPropertyDescriptor(t,e){const n=z(t),s=Reflect.getOwnPropertyDescriptor(n,e);return s&&{writable:!0,configurable:t.type_!==1||e!=="length",enumerable:s.enumerable,value:n[e]}},defineProperty(){L(11)},getPrototypeOf(t){return K(t.base_)},setPrototypeOf(){L(12)}},le={};ae(He,(t,e)=>{le[t]=function(){return arguments[0]=arguments[0][0],e.apply(this,arguments)}});le.deleteProperty=function(t,e){return le.set.call(this,t,e,void 0)};le.set=function(t,e,n){return He.set.call(this,t[0],e,n,t[0])};function Ce(t,e){const n=t[U];return(n?z(n):t)[e]}function nn(t,e,n){const s=Tt(e,n);return s?"value"in s?s.value:s.get?.call(t.draft_):void 0}function Tt(t,e){if(!(e in t))return;let n=K(t);for(;n;){const s=Object.getOwnPropertyDescriptor(n,e);if(s)return s;n=K(n)}}function De(t){t.modified_||(t.modified_=!0,t.parent_&&De(t.parent_))}function Ie(t){t.copy_||(t.copy_=we(t.base_,t.scope_.immer_.useStrictShallowCopy_))}var sn=class{constructor(t){this.autoFreeze_=!0,this.useStrictShallowCopy_=!1,this.produce=(e,n,s)=>{if(typeof e=="function"&&typeof n!="function"){const o=n;n=e;const r=this;return function(l=o,...u){return r.produce(l,c=>n.call(this,c,...u))}}typeof n!="function"&&L(6),s!==void 0&&typeof s!="function"&&L(7);let i;if(Y(e)){const o=qe(this),r=be(e,void 0);let a=!0;try{i=n(r),a=!1}finally{a?Le(o):Me(o)}return Je(o,s),et(i,o)}else if(!e||typeof e!="object"){if(i=n(e),i===void 0&&(i=e),i===Ve&&(i=void 0),this.autoFreeze_&&ke(i,!0),s){const o=[],r=[];Z("Patches").generateReplacementPatches_(e,i,o,r),s(o,r)}return i}else L(1,e)},this.produceWithPatches=(e,n)=>{if(typeof e=="function")return(r,...a)=>this.produceWithPatches(r,l=>e(l,...a));let s,i;return[this.produce(e,n,(r,a)=>{s=r,i=a}),s,i]},typeof t?.autoFreeze=="boolean"&&this.setAutoFreeze(t.autoFreeze),typeof t?.useStrictShallowCopy=="boolean"&&this.setUseStrictShallowCopy(t.useStrictShallowCopy)}createDraft(t){Y(t)||L(8),X(t)&&(t=on(t));const e=qe(this),n=be(t,void 0);return n[U].isManual_=!0,Me(e),n}finishDraft(t,e){const n=t&&t[U];(!n||!n.isManual_)&&L(9);const{scope_:s}=n;return Je(s,e),et(void 0,s)}setAutoFreeze(t){this.autoFreeze_=t}setUseStrictShallowCopy(t){this.useStrictShallowCopy_=t}applyPatches(t,e){let n;for(n=e.length-1;n>=0;n--){const i=e[n];if(i.path.length===0&&i.op==="replace"){t=i.value;break}}n>-1&&(e=e.slice(n+1));const s=Z("Patches").applyPatches_;return X(t)?s(t,e):this.produce(t,i=>s(i,e))}};function be(t,e){const n=he(t)?Z("MapSet").proxyMap_(t,e):fe(t)?Z("MapSet").proxySet_(t,e):tn(t,e);return(e?e.scope_:mt()).drafts_.push(n),n}function on(t){return X(t)||L(10,t),pt(t)}function pt(t){if(!Y(t)||Re(t))return t;const e=t[U];let n;if(e){if(!e.modified_)return e.base_;e.finalized_=!0,n=we(t,e.scope_.immer_.useStrictShallowCopy_)}else n=we(t,!0);return ae(n,(s,i)=>{Ot(n,s,pt(i))}),e&&(e.finalized_=!1),n}function Fe(){const e="replace",n="add",s="remove";function i(_,I,g,v){switch(_.type_){case 0:case 2:return r(_,I,g,v);case 1:return o(_,I,g,v);case 3:return a(_,I,g,v)}}function o(_,I,g,v){let{base_:S,assigned_:R}=_,C=_.copy_;C.length<S.length&&([S,C]=[C,S],[g,v]=[v,g]);for(let y=0;y<S.length;y++)if(R[y]&&C[y]!==S[y]){const A=I.concat([y]);g.push({op:e,path:A,value:d(C[y])}),v.push({op:e,path:A,value:d(S[y])})}for(let y=S.length;y<C.length;y++){const A=I.concat([y]);g.push({op:n,path:A,value:d(C[y])})}for(let y=C.length-1;S.length<=y;--y){const A=I.concat([y]);v.push({op:s,path:A})}}function r(_,I,g,v){const{base_:S,copy_:R}=_;ae(_.assigned_,(C,y)=>{const A=ve(S,C),H=ve(R,C),G=y?de(S,C)?e:n:s;if(A===H&&G===e)return;const E=I.concat(C);g.push(G===s?{op:G,path:E}:{op:G,path:E,value:H}),v.push(G===n?{op:s,path:E}:G===s?{op:n,path:E,value:d(A)}:{op:e,path:E,value:d(A)})})}function a(_,I,g,v){let{base_:S,copy_:R}=_,C=0;S.forEach(y=>{if(!R.has(y)){const A=I.concat([C]);g.push({op:s,path:A,value:y}),v.unshift({op:n,path:A,value:y})}C++}),C=0,R.forEach(y=>{if(!S.has(y)){const A=I.concat([C]);g.push({op:n,path:A,value:y}),v.unshift({op:s,path:A,value:y})}C++})}function l(_,I,g,v){g.push({op:e,path:[],value:I===Ve?void 0:I}),v.push({op:e,path:[],value:_})}function u(_,I){return I.forEach(g=>{const{path:v,op:S}=g;let R=_;for(let H=0;H<v.length-1;H++){const G=Q(R);let E=v[H];typeof E!="string"&&typeof E!="number"&&(E=""+E),(G===0||G===1)&&(E==="__proto__"||E==="constructor")&&L(16+3),typeof R=="function"&&E==="prototype"&&L(16+3),R=ve(R,E),typeof R!="object"&&L(16+2,v.join("/"))}const C=Q(R),y=c(g.value),A=v[v.length-1];switch(S){case e:switch(C){case 2:return R.set(A,y);case 3:L(16);default:return R[A]=y}case n:switch(C){case 1:return A==="-"?R.push(y):R.splice(A,0,y);case 2:return R.set(A,y);case 3:return R.add(y);default:return R[A]=y}case s:switch(C){case 1:return R.splice(A,1);case 2:return R.delete(A);case 3:return R.delete(g.value);default:return delete R[A]}default:L(16+1,S)}}),_}function c(_){if(!Y(_))return _;if(Array.isArray(_))return _.map(c);if(he(_))return new Map(Array.from(_.entries()).map(([g,v])=>[g,c(v)]));if(fe(_))return new Set(Array.from(_).map(c));const I=Object.create(K(_));for(const g in _)I[g]=c(_[g]);return de(_,re)&&(I[re]=_[re]),I}function d(_){return X(_)?c(_):_}Jt("Patches",{applyPatches_:u,generatePatches_:i,generateReplacementPatches_:l})}var V=new sn;V.produce;var We=V.produceWithPatches.bind(V);V.setAutoFreeze.bind(V);V.setUseStrictShallowCopy.bind(V);V.applyPatches.bind(V);V.createDraft.bind(V);V.finishDraft.bind(V);var ne=globalThis&&globalThis.__awaiter||function(t,e,n,s){function i(o){return o instanceof n?o:new n(function(r){r(o)})}return new(n||(n=Promise))(function(o,r){function a(c){try{u(s.next(c))}catch(d){r(d)}}function l(c){try{u(s.throw(c))}catch(d){r(d)}}function u(c){c.done?o(c.value):i(c.value).then(a,l)}u((s=s.apply(t,e||[])).next())})};Fe();class rn{constructor(e){this.messageBus=e}getItems(e){return ne(this,void 0,void 0,function*(){if(Array.isArray(e)){const{items:n}=yield this.messageBus.sendAsync("OBR_SCENE_ITEMS_GET_ITEMS",{ids:e});return n}else if(e){const{items:n}=yield this.messageBus.sendAsync("OBR_SCENE_ITEMS_GET_ALL_ITEMS",{});return n.filter(e)}else{const{items:n}=yield this.messageBus.sendAsync("OBR_SCENE_ITEMS_GET_ALL_ITEMS",{});return n}})}isItemArray(e){return Array.isArray(e)&&e.every(n=>typeof n!="string")}updateItems(e,n){return ne(this,void 0,void 0,function*(){let s;this.isItemArray(e)?s=e:s=yield this.getItems(e);const[i,o]=We(s,n),r=i.map(l=>({id:l.id,type:l.type}));for(const l of o){const[u,c]=l.path;typeof u=="number"&&typeof c=="string"&&(r[u][c]=i[u][c])}const a=r.filter(l=>Object.keys(l).length>2);a.length!==0&&(yield this.messageBus.sendAsync("OBR_SCENE_ITEMS_UPDATE_ITEMS",{updates:a}))})}addItems(e){return ne(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_SCENE_ITEMS_ADD_ITEMS",{items:e})})}deleteItems(e){return ne(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_SCENE_ITEMS_DELETE_ITEMS",{ids:e})})}getItemAttachments(e){return ne(this,void 0,void 0,function*(){const{items:n}=yield this.messageBus.sendAsync("OBR_SCENE_ITEMS_GET_ITEM_ATTACHMENTS",{ids:e});return n})}getItemBounds(e){return ne(this,void 0,void 0,function*(){const{bounds:n}=yield this.messageBus.sendAsync("OBR_SCENE_ITEMS_GET_ITEM_BOUNDS",{ids:e});return n})}onChange(e){const n=s=>{e(s.items)};return this.messageBus.send("OBR_SCENE_ITEMS_SUBSCRIBE",{}),this.messageBus.on("OBR_SCENE_ITEMS_EVENT_CHANGE",n),()=>{this.messageBus.send("OBR_SCENE_ITEMS_UNSUBSCRIBE",{}),this.messageBus.off("OBR_SCENE_ITEMS_EVENT_CHANGE",n)}}}var se=globalThis&&globalThis.__awaiter||function(t,e,n,s){function i(o){return o instanceof n?o:new n(function(r){r(o)})}return new(n||(n=Promise))(function(o,r){function a(c){try{u(s.next(c))}catch(d){r(d)}}function l(c){try{u(s.throw(c))}catch(d){r(d)}}function u(c){c.done?o(c.value):i(c.value).then(a,l)}u((s=s.apply(t,e||[])).next())})};Fe();class cn{constructor(e){this.messageBus=e}getItems(e){return se(this,void 0,void 0,function*(){if(Array.isArray(e)){const{items:n}=yield this.messageBus.sendAsync("OBR_SCENE_LOCAL_GET_ITEMS",{ids:e});return n}else if(e){const{items:n}=yield this.messageBus.sendAsync("OBR_SCENE_LOCAL_GET_ALL_ITEMS",{});return n.filter(e)}else{const{items:n}=yield this.messageBus.sendAsync("OBR_SCENE_LOCAL_GET_ALL_ITEMS",{});return n}})}isItemArray(e){return Array.isArray(e)&&e.every(n=>typeof n!="string")}updateItems(e,n,s){return se(this,void 0,void 0,function*(){let i;this.isItemArray(e)?i=e:i=yield this.getItems(e);const[o,r]=We(i,n),a=o.map(u=>({id:u.id,type:u.type}));for(const u of r){const[c,d]=u.path;typeof c=="number"&&typeof d=="string"&&(a[c][d]=o[c][d])}const l=a.filter(u=>Object.keys(u).length>2);l.length!==0&&(yield this.messageBus.sendAsync("OBR_SCENE_LOCAL_UPDATE_ITEMS",{updates:l,fastUpdate:s}))})}addItems(e){return se(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_SCENE_LOCAL_ADD_ITEMS",{items:e})})}deleteItems(e){return se(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_SCENE_LOCAL_DELETE_ITEMS",{ids:e})})}getItemAttachments(e){return se(this,void 0,void 0,function*(){const{items:n}=yield this.messageBus.sendAsync("OBR_SCENE_LOCAL_GET_ITEM_ATTACHMENTS",{ids:e});return n})}getItemBounds(e){return se(this,void 0,void 0,function*(){const{bounds:n}=yield this.messageBus.sendAsync("OBR_SCENE_LOCAL_GET_ITEM_BOUNDS",{ids:e});return n})}onChange(e){const n=s=>{e(s.items)};return this.messageBus.send("OBR_SCENE_LOCAL_SUBSCRIBE",{}),this.messageBus.on("OBR_SCENE_LOCAL_EVENT_CHANGE",n),()=>{this.messageBus.send("OBR_SCENE_LOCAL_UNSUBSCRIBE",{}),this.messageBus.off("OBR_SCENE_LOCAL_EVENT_CHANGE",n)}}}var Se=globalThis&&globalThis.__awaiter||function(t,e,n,s){function i(o){return o instanceof n?o:new n(function(r){r(o)})}return new(n||(n=Promise))(function(o,r){function a(c){try{u(s.next(c))}catch(d){r(d)}}function l(c){try{u(s.throw(c))}catch(d){r(d)}}function u(c){c.done?o(c.value):i(c.value).then(a,l)}u((s=s.apply(t,e||[])).next())})};class an{constructor(e){this.messageBus=e,this.grid=new jt(e),this.fog=new zt(e),this.history=new Kt(e),this.items=new rn(e),this.local=new cn(e)}isReady(){return Se(this,void 0,void 0,function*(){const{ready:e}=yield this.messageBus.sendAsync("OBR_SCENE_IS_READY",{});return e})}onReadyChange(e){const n=s=>{e(s.ready)};return this.messageBus.send("OBR_SCENE_READY_SUBSCRIBE",{}),this.messageBus.on("OBR_SCENE_EVENT_READY_CHANGE",n),()=>{this.messageBus.send("OBR_SCENE_READY_UNSUBSCRIBE",{}),this.messageBus.off("OBR_SCENE_EVENT_READY_CHANGE",n)}}getMetadata(){return Se(this,void 0,void 0,function*(){const{metadata:e}=yield this.messageBus.sendAsync("OBR_SCENE_GET_METADATA",{});return e})}setMetadata(e){return Se(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_SCENE_SET_METADATA",{update:e})})}onMetadataChange(e){const n=s=>{e(s.metadata)};return this.messageBus.send("OBR_SCENE_METADATA_SUBSCRIBE",{}),this.messageBus.on("OBR_SCENE_METADATA_EVENT_CHANGE",n),()=>{this.messageBus.send("OBR_SCENE_METADATA_UNSUBSCRIBE",{}),this.messageBus.off("OBR_SCENE_METADATA_EVENT_CHANGE",n)}}}function At(t){return t.startsWith("http")?t:`${window.location.origin}${t}`}function ce(t){return t.map(e=>Object.assign(Object.assign({},e),{icon:At(e.icon)}))}function $e(t){return Object.assign(Object.assign({},t),{url:At(t.url)})}var nt=globalThis&&globalThis.__awaiter||function(t,e,n,s){function i(o){return o instanceof n?o:new n(function(r){r(o)})}return new(n||(n=Promise))(function(o,r){function a(c){try{u(s.next(c))}catch(d){r(d)}}function l(c){try{u(s.throw(c))}catch(d){r(d)}}function u(c){c.done?o(c.value):i(c.value).then(a,l)}u((s=s.apply(t,e||[])).next())})};class dn{constructor(e){this.contextMenus={},this.handleClick=n=>{var s;const i=this.contextMenus[n.id];i&&((s=i.onClick)===null||s===void 0||s.call(i,n.context,n.elementId))},this.messageBus=e,e.on("OBR_CONTEXT_MENU_EVENT_CLICK",this.handleClick)}create(e){return nt(this,void 0,void 0,function*(){this.messageBus.sendAsync("OBR_CONTEXT_MENU_CREATE",{id:e.id,shortcut:e.shortcut,icons:ce(e.icons),embed:e.embed&&$e(e.embed)}),this.contextMenus[e.id]=e})}remove(e){return nt(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_CONTEXT_MENU_REMOVE",{id:e}),delete this.contextMenus[e]})}}var k=globalThis&&globalThis.__awaiter||function(t,e,n,s){function i(o){return o instanceof n?o:new n(function(r){r(o)})}return new(n||(n=Promise))(function(o,r){function a(c){try{u(s.next(c))}catch(d){r(d)}}function l(c){try{u(s.throw(c))}catch(d){r(d)}}function u(c){c.done?o(c.value):i(c.value).then(a,l)}u((s=s.apply(t,e||[])).next())})};class un{constructor(e){this.tools={},this.toolActions={},this.toolModes={},this.handleToolClick=n=>{const s=this.tools[n.id];if(s)if(s.onClick){const i=s.onClick(n.context,n.elementId);Promise.resolve(i).then(o=>{o&&this.messageBus.send("OBR_TOOL_ACTIVATE",{id:n.id})})}else this.messageBus.send("OBR_TOOL_ACTIVATE",{id:n.id})},this.handleToolActionClick=n=>{var s;const i=this.toolActions[n.id];i&&((s=i.onClick)===null||s===void 0||s.call(i,n.context,n.elementId))},this.handleToolModeClick=n=>{const s=this.toolModes[n.id];if(s)if(s.onClick){const i=s.onClick(n.context,n.elementId);Promise.resolve(i).then(o=>{o&&this.messageBus.send("OBR_TOOL_MODE_ACTIVATE",{toolId:n.context.activeTool,modeId:n.id})})}else this.messageBus.send("OBR_TOOL_MODE_ACTIVATE",{toolId:n.context.activeTool,modeId:n.id})},this.handleToolModeToolClick=n=>{const s=this.toolModes[n.id];if(s)if(s.onToolClick){const i=s.onToolClick(n.context,n.event);Promise.resolve(i).then(o=>{o&&n.event.target&&!n.event.target.locked&&this.messageBus.sendAsync("OBR_PLAYER_SELECT",{items:[n.event.target.id]})})}else n.event.target&&!n.event.target.locked&&this.messageBus.sendAsync("OBR_PLAYER_SELECT",{items:[n.event.target.id]})},this.handleToolModeToolDoubleClick=n=>{const s=this.toolModes[n.id];if(s)if(s.onToolDoubleClick){const i=s.onToolDoubleClick(n.context,n.event);Promise.resolve(i).then(o=>{o&&n.event.target&&this.messageBus.sendAsync("OBR_PLAYER_SELECT",{items:[n.event.target.id]})})}else n.event.target&&this.messageBus.sendAsync("OBR_PLAYER_SELECT",{items:[n.event.target.id]})},this.handleToolModeToolDown=n=>{var s;const i=this.toolModes[n.id];i&&((s=i.onToolDown)===null||s===void 0||s.call(i,n.context,n.event))},this.handleToolModeToolMove=n=>{var s;const i=this.toolModes[n.id];i&&((s=i.onToolMove)===null||s===void 0||s.call(i,n.context,n.event))},this.handleToolModeToolUp=n=>{var s;const i=this.toolModes[n.id];i&&((s=i.onToolUp)===null||s===void 0||s.call(i,n.context,n.event))},this.handleToolModeToolDragStart=n=>{var s;const i=this.toolModes[n.id];i&&((s=i.onToolDragStart)===null||s===void 0||s.call(i,n.context,n.event))},this.handleToolModeToolDragMove=n=>{var s;const i=this.toolModes[n.id];i&&((s=i.onToolDragMove)===null||s===void 0||s.call(i,n.context,n.event))},this.handleToolModeToolDragEnd=n=>{var s;const i=this.toolModes[n.id];i&&((s=i.onToolDragEnd)===null||s===void 0||s.call(i,n.context,n.event))},this.handleToolModeToolDragCancel=n=>{var s;const i=this.toolModes[n.id];i&&((s=i.onToolDragCancel)===null||s===void 0||s.call(i,n.context,n.event))},this.handleToolModeKeyDown=n=>{var s;const i=this.toolModes[n.id];i&&((s=i.onKeyDown)===null||s===void 0||s.call(i,n.context,n.event))},this.handleToolModeKeyUp=n=>{var s;const i=this.toolModes[n.id];i&&((s=i.onKeyUp)===null||s===void 0||s.call(i,n.context,n.event))},this.handleToolModeActivate=n=>{var s;const i=this.toolModes[n.id];i&&((s=i.onActivate)===null||s===void 0||s.call(i,n.context))},this.handleToolModeDeactivate=n=>{var s;const i=this.toolModes[n.id];i&&((s=i.onDeactivate)===null||s===void 0||s.call(i,n.context))},this.messageBus=e,e.on("OBR_TOOL_EVENT_CLICK",this.handleToolClick),e.on("OBR_TOOL_ACTION_EVENT_CLICK",this.handleToolActionClick),e.on("OBR_TOOL_MODE_EVENT_CLICK",this.handleToolModeClick),e.on("OBR_TOOL_MODE_EVENT_TOOL_CLICK",this.handleToolModeToolClick),e.on("OBR_TOOL_MODE_EVENT_TOOL_DOUBLE_CLICK",this.handleToolModeToolDoubleClick),e.on("OBR_TOOL_MODE_EVENT_TOOL_DOWN",this.handleToolModeToolDown),e.on("OBR_TOOL_MODE_EVENT_TOOL_MOVE",this.handleToolModeToolMove),e.on("OBR_TOOL_MODE_EVENT_TOOL_UP",this.handleToolModeToolUp),e.on("OBR_TOOL_MODE_EVENT_TOOL_DRAG_START",this.handleToolModeToolDragStart),e.on("OBR_TOOL_MODE_EVENT_TOOL_DRAG_MOVE",this.handleToolModeToolDragMove),e.on("OBR_TOOL_MODE_EVENT_TOOL_DRAG_END",this.handleToolModeToolDragEnd),e.on("OBR_TOOL_MODE_EVENT_TOOL_DRAG_CANCEL",this.handleToolModeToolDragCancel),e.on("OBR_TOOL_MODE_EVENT_KEY_DOWN",this.handleToolModeKeyDown),e.on("OBR_TOOL_MODE_EVENT_KEY_UP",this.handleToolModeKeyUp),e.on("OBR_TOOL_MODE_EVENT_ACTIVATE",this.handleToolModeActivate),e.on("OBR_TOOL_MODE_EVENT_DEACTIVATE",this.handleToolModeDeactivate)}create(e){return k(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_TOOL_CREATE",{id:e.id,shortcut:e.shortcut,defaultMode:e.defaultMode,defaultMetadata:e.defaultMetadata,icons:ce(e.icons),disabled:e.disabled}),this.tools[e.id]=e})}remove(e){return k(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_TOOL_REMOVE",{id:e}),delete this.tools[e]})}activateTool(e){return k(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_TOOL_ACTIVATE",{id:e})})}getActiveTool(){return k(this,void 0,void 0,function*(){const{id:e}=yield this.messageBus.sendAsync("OBR_TOOL_GET_ACTIVE",{});return e})}onToolChange(e){const n=s=>{e(s.id)};return this.messageBus.send("OBR_TOOL_ACTIVE_SUBSCRIBE",{}),this.messageBus.on("OBR_TOOL_ACTIVE_EVENT_CHANGE",n),()=>{this.messageBus.send("OBR_TOOL_ACTIVE_UNSUBSCRIBE",{}),this.messageBus.off("OBR_TOOL_ACTIVE_EVENT_CHANGE",n)}}getMetadata(e){return k(this,void 0,void 0,function*(){const{metadata:n}=yield this.messageBus.sendAsync("OBR_TOOL_GET_METADATA",{id:e});return n})}setMetadata(e,n){return k(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_TOOL_SET_METADATA",{toolId:e,update:n})})}createAction(e){return k(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_TOOL_ACTION_CREATE",{id:e.id,shortcut:e.shortcut,icons:ce(e.icons),disabled:e.disabled}),this.toolActions[e.id]=e})}removeAction(e){return k(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_TOOL_ACTION_REMOVE",{id:e}),delete this.tools[e]})}createMode(e){return k(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_TOOL_MODE_CREATE",{id:e.id,shortcut:e.shortcut,icons:ce(e.icons),preventDrag:e.preventDrag,disabled:e.disabled,cursors:e.cursors}),this.toolModes[e.id]=e})}removeMode(e){return k(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_TOOL_MODE_REMOVE",{id:e}),delete this.tools[e]})}activateMode(e,n){return k(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_TOOL_MODE_ACTIVATE",{toolId:e,modeId:n})})}getActiveToolMode(){return k(this,void 0,void 0,function*(){const{id:e}=yield this.messageBus.sendAsync("OBR_TOOL_MODE_GET_ACTIVE",{});return e})}onToolModeChange(e){const n=s=>{e(s.id)};return this.messageBus.send("OBR_TOOL_MODE_ACTIVE_SUBSCRIBE",{}),this.messageBus.on("OBR_TOOL_MODE_ACTIVE_EVENT_CHANGE",n),()=>{this.messageBus.send("OBR_TOOL_MODE_ACTIVE_UNSUBSCRIBE",{}),this.messageBus.off("OBR_TOOL_MODE_ACTIVE_EVENT_CHANGE",n)}}}var ie=globalThis&&globalThis.__awaiter||function(t,e,n,s){function i(o){return o instanceof n?o:new n(function(r){r(o)})}return new(n||(n=Promise))(function(o,r){function a(c){try{u(s.next(c))}catch(d){r(d)}}function l(c){try{u(s.throw(c))}catch(d){r(d)}}function u(c){c.done?o(c.value):i(c.value).then(a,l)}u((s=s.apply(t,e||[])).next())})};class ln{constructor(e){this.messageBus=e}open(e){return ie(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_POPOVER_OPEN",Object.assign({},$e(e)))})}close(e){return ie(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_POPOVER_CLOSE",{id:e})})}getWidth(e){return ie(this,void 0,void 0,function*(){const{width:n}=yield this.messageBus.sendAsync("OBR_POPOVER_GET_WIDTH",{id:e});return n})}setWidth(e,n){return ie(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_POPOVER_SET_WIDTH",{id:e,width:n})})}getHeight(e){return ie(this,void 0,void 0,function*(){const{height:n}=yield this.messageBus.sendAsync("OBR_POPOVER_GET_HEIGHT",{id:e});return n})}setHeight(e,n){return ie(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_POPOVER_SET_HEIGHT",{id:e,height:n})})}}var st=globalThis&&globalThis.__awaiter||function(t,e,n,s){function i(o){return o instanceof n?o:new n(function(r){r(o)})}return new(n||(n=Promise))(function(o,r){function a(c){try{u(s.next(c))}catch(d){r(d)}}function l(c){try{u(s.throw(c))}catch(d){r(d)}}function u(c){c.done?o(c.value):i(c.value).then(a,l)}u((s=s.apply(t,e||[])).next())})};class hn{constructor(e){this.messageBus=e}open(e){return st(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_MODAL_OPEN",Object.assign({},$e(e)))})}close(e){return st(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_MODAL_CLOSE",{id:e})})}}var b=globalThis&&globalThis.__awaiter||function(t,e,n,s){function i(o){return o instanceof n?o:new n(function(r){r(o)})}return new(n||(n=Promise))(function(o,r){function a(c){try{u(s.next(c))}catch(d){r(d)}}function l(c){try{u(s.throw(c))}catch(d){r(d)}}function u(c){c.done?o(c.value):i(c.value).then(a,l)}u((s=s.apply(t,e||[])).next())})};class fn{constructor(e){this.messageBus=e}getWidth(){return b(this,void 0,void 0,function*(){const{width:e}=yield this.messageBus.sendAsync("OBR_ACTION_GET_WIDTH",{});return e})}setWidth(e){return b(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_ACTION_SET_WIDTH",{width:e})})}getHeight(){return b(this,void 0,void 0,function*(){const{height:e}=yield this.messageBus.sendAsync("OBR_ACTION_GET_HEIGHT",{});return e})}setHeight(e){return b(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_ACTION_SET_HEIGHT",{height:e})})}getBadgeText(){return b(this,void 0,void 0,function*(){const{badgeText:e}=yield this.messageBus.sendAsync("OBR_ACTION_GET_BADGE_TEXT",{});return e})}setBadgeText(e){return b(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_ACTION_SET_BADGE_TEXT",{badgeText:e})})}getBadgeBackgroundColor(){return b(this,void 0,void 0,function*(){const{badgeBackgroundColor:e}=yield this.messageBus.sendAsync("OBR_ACTION_GET_BADGE_BACKGROUND_COLOR",{});return e})}setBadgeBackgroundColor(e){return b(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_ACTION_SET_BADGE_BACKGROUND_COLOR",{badgeBackgroundColor:e})})}getIcon(){return b(this,void 0,void 0,function*(){const{icon:e}=yield this.messageBus.sendAsync("OBR_ACTION_GET_ICON",{});return e})}setIcon(e){return b(this,void 0,void 0,function*(){const n=ce([{icon:e}]);yield this.messageBus.sendAsync("OBR_ACTION_SET_ICON",{icon:n[0].icon})})}getTitle(){return b(this,void 0,void 0,function*(){const{title:e}=yield this.messageBus.sendAsync("OBR_ACTION_GET_TITLE",{});return e})}setTitle(e){return b(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_ACTION_SET_TITLE",{title:e})})}isOpen(){return b(this,void 0,void 0,function*(){const{isOpen:e}=yield this.messageBus.sendAsync("OBR_ACTION_GET_IS_OPEN",{});return e})}open(){return b(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_ACTION_OPEN",{})})}close(){return b(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_ACTION_CLOSE",{})})}onOpenChange(e){const n=s=>{e(s.isOpen)};return this.messageBus.send("OBR_ACTION_IS_OPEN_SUBSCRIBE",{}),this.messageBus.on("OBR_ACTION_IS_OPEN_EVENT_CHANGE",n),()=>{this.messageBus.send("OBR_IS_OPEN_ACTION_UNSUBSCRIBE",{}),this.messageBus.off("OBR_ACTION_IS_OPEN_EVENT_CHANGE",n)}}}var _n=globalThis&&globalThis.__awaiter||function(t,e,n,s){function i(o){return o instanceof n?o:new n(function(r){r(o)})}return new(n||(n=Promise))(function(o,r){function a(c){try{u(s.next(c))}catch(d){r(d)}}function l(c){try{u(s.throw(c))}catch(d){r(d)}}function u(c){c.done?o(c.value):i(c.value).then(a,l)}u((s=s.apply(t,e||[])).next())})};Fe();class En{constructor(e){this.messageBus=e}startItemInteraction(e){return _n(this,void 0,void 0,function*(){const{id:n}=yield this.messageBus.sendAsync("OBR_INTERACTION_START_ITEM_INTERACTION",{baseState:e});let s=e;return[r=>{const[a,l]=We(s,r);return s=a,this.messageBus.send("OBR_INTERACTION_UPDATE_ITEM_INTERACTION",{id:n,patches:l}),a},()=>{this.messageBus.send("OBR_INTERACTION_STOP_ITEM_INTERACTION",{id:n})}]})}}var yn=globalThis&&globalThis.__awaiter||function(t,e,n,s){function i(o){return o instanceof n?o:new n(function(r){r(o)})}return new(n||(n=Promise))(function(o,r){function a(c){try{u(s.next(c))}catch(d){r(d)}}function l(c){try{u(s.throw(c))}catch(d){r(d)}}function u(c){c.done?o(c.value):i(c.value).then(a,l)}u((s=s.apply(t,e||[])).next())})};class On{constructor(e){this.messageBus=e}getPlayers(){return yn(this,void 0,void 0,function*(){const{players:e}=yield this.messageBus.sendAsync("OBR_PARTY_GET_PLAYERS",{});return e})}onChange(e){const n=s=>{e(s.players)};return this.messageBus.send("OBR_PARTY_SUBSCRIBE",{}),this.messageBus.on("OBR_PARTY_EVENT_CHANGE",n),()=>{this.messageBus.send("OBR_PARTY_UNSUBSCRIBE",{}),this.messageBus.off("OBR_PARTY_EVENT_CHANGE",n)}}}var Ne=globalThis&&globalThis.__awaiter||function(t,e,n,s){function i(o){return o instanceof n?o:new n(function(r){r(o)})}return new(n||(n=Promise))(function(o,r){function a(c){try{u(s.next(c))}catch(d){r(d)}}function l(c){try{u(s.throw(c))}catch(d){r(d)}}function u(c){c.done?o(c.value):i(c.value).then(a,l)}u((s=s.apply(t,e||[])).next())})};class mn{constructor(e){this.messageBus=e}get id(){return this.messageBus.roomId}getPermissions(){return Ne(this,void 0,void 0,function*(){const{permissions:e}=yield this.messageBus.sendAsync("OBR_ROOM_GET_PERMISSIONS",{});return e})}getMetadata(){return Ne(this,void 0,void 0,function*(){const{metadata:e}=yield this.messageBus.sendAsync("OBR_ROOM_GET_METADATA",{});return e})}setMetadata(e){return Ne(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_ROOM_SET_METADATA",{update:e})})}onMetadataChange(e){const n=s=>{e(s.metadata)};return this.messageBus.send("OBR_ROOM_METADATA_SUBSCRIBE",{}),this.messageBus.on("OBR_ROOM_METADATA_EVENT_CHANGE",n),()=>{this.messageBus.send("OBR_METADATA_ROOM_UNSUBSCRIBE",{}),this.messageBus.off("OBR_ROOM_METADATA_EVENT_CHANGE",n)}}onPermissionsChange(e){const n=s=>{e(s.permissions)};return this.messageBus.send("OBR_ROOM_PERMISSIONS_SUBSCRIBE",{}),this.messageBus.on("OBR_ROOM_PERMISSIONS_EVENT_CHANGE",n),()=>{this.messageBus.send("OBR_PERMISSIONS_ROOM_UNSUBSCRIBE",{}),this.messageBus.off("OBR_ROOM_PERMISSIONS_EVENT_CHANGE",n)}}}var Tn=globalThis&&globalThis.__awaiter||function(t,e,n,s){function i(o){return o instanceof n?o:new n(function(r){r(o)})}return new(n||(n=Promise))(function(o,r){function a(c){try{u(s.next(c))}catch(d){r(d)}}function l(c){try{u(s.throw(c))}catch(d){r(d)}}function u(c){c.done?o(c.value):i(c.value).then(a,l)}u((s=s.apply(t,e||[])).next())})};class pn{constructor(e){this.messageBus=e}getTheme(){return Tn(this,void 0,void 0,function*(){const{theme:e}=yield this.messageBus.sendAsync("OBR_THEME_GET_THEME",{});return e})}onChange(e){const n=s=>{e(s.theme)};return this.messageBus.send("OBR_THEME_SUBSCRIBE",{}),this.messageBus.on("OBR_THEME_EVENT_CHANGE",n),()=>{this.messageBus.send("OBR_THEME_UNSUBSCRIBE",{}),this.messageBus.off("OBR_THEME_EVENT_CHANGE",n)}}}var me=globalThis&&globalThis.__awaiter||function(t,e,n,s){function i(o){return o instanceof n?o:new n(function(r){r(o)})}return new(n||(n=Promise))(function(o,r){function a(c){try{u(s.next(c))}catch(d){r(d)}}function l(c){try{u(s.throw(c))}catch(d){r(d)}}function u(c){c.done?o(c.value):i(c.value).then(a,l)}u((s=s.apply(t,e||[])).next())})};class An{constructor(e){this.messageBus=e}uploadImages(e,n){return me(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_ASSETS_UPLOAD_IMAGES",{images:e,typeHint:n})})}uploadScenes(e,n){return me(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_ASSETS_UPLOAD_SCENES",{scenes:e,disableShowScenes:n})})}downloadImages(e,n,s){return me(this,void 0,void 0,function*(){const{images:i}=yield this.messageBus.sendAsync("OBR_ASSETS_DOWNLOAD_IMAGES",{multiple:e,defaultSearch:n,typeHint:s},-1);return i})}downloadScenes(e,n){return me(this,void 0,void 0,function*(){const{scenes:s}=yield this.messageBus.sendAsync("OBR_ASSETS_DOWNLOAD_SCENES",{multiple:e,defaultSearch:n},-1);return s})}}var gn=globalThis&&globalThis.__awaiter||function(t,e,n,s){function i(o){return o instanceof n?o:new n(function(r){r(o)})}return new(n||(n=Promise))(function(o,r){function a(c){try{u(s.next(c))}catch(d){r(d)}}function l(c){try{u(s.throw(c))}catch(d){r(d)}}function u(c){c.done?o(c.value):i(c.value).then(a,l)}u((s=s.apply(t,e||[])).next())})};class Bn{constructor(e){this.messageBus=e}sendMessage(e,n,s){return gn(this,void 0,void 0,function*(){yield this.messageBus.sendAsync("OBR_BROADCAST_SEND_MESSAGE",{channel:e,data:n,options:s})})}onMessage(e,n){return this.messageBus.send("OBR_BROADCAST_SUBSCRIBE",{channel:e}),this.messageBus.on(`OBR_BROADCAST_MESSAGE_${e}`,n),()=>{this.messageBus.send("OBR_BROADCAST_UNSUBSCRIBE",{channel:e}),this.messageBus.off(`OBR_BROADCAST_MESSAGE_${e}`,n)}}}class gt{constructor(e){this._item={createdUserId:e.id,id:Et(),name:"Item",zIndex:Date.now(),lastModified:new Date().toISOString(),lastModifiedUserId:e.id,locked:!1,metadata:{},position:{x:0,y:0},rotation:0,scale:{x:1,y:1},type:"ITEM",visible:!0,layer:"POPOVER"}}createdUserId(e){return this._item.createdUserId=e,this.self()}id(e){return this._item.id=e,this.self()}name(e){return this._item.name=e,this.self()}description(e){return this._item.description=e,this.self()}lastModified(e){return this._item.lastModified=e,this.self()}zIndex(e){return this._item.zIndex=e,this.self()}lastModifiedUserId(e){return this._item.lastModifiedUserId=e,this.self()}locked(e){return this._item.locked=e,this.self()}metadata(e){return this._item.metadata=e,this.self()}position(e){return this._item.position=e,this.self()}rotation(e){return this._item.rotation=e,this.self()}scale(e){return this._item.scale=e,this.self()}visible(e){return this._item.visible=e,this.self()}attachedTo(e){return this._item.attachedTo=e,this.self()}layer(e){return this._item.layer=e,this.self()}disableHit(e){return this._item.disableHit=e,this.self()}disableAutoZIndex(e){return this._item.disableAutoZIndex=e,this.self()}disableAttachmentBehavior(e){return this._item.disableAttachmentBehavior=e,this.self()}self(){return this}}class Rn extends gt{constructor(e){super(e),this._text={richText:[{type:"paragraph",children:[{text:""}]}],plainText:"",style:{padding:0,fontFamily:"Roboto",fontSize:16,fontWeight:400,textAlign:"LEFT",textAlignVertical:"TOP",fillColor:"white",fillOpacity:1,strokeColor:"white",strokeOpacity:1,strokeWidth:0,lineHeight:1.5},type:"RICH",width:"AUTO",height:"AUTO"},this._item.layer="TEXT",this._item.name="Text"}text(e){return this._text=e,this.self()}width(e){return this._text.width=e,this.self()}height(e){return this._text.height=e,this.self()}richText(e){return this._text.richText=e,this.self()}plainText(e){return this._text.plainText=e,this.self()}textType(e){return this._text.type=e,this.self()}padding(e){return this._text.style.padding=e,this.self()}fontFamily(e){return this._text.style.fontFamily=e,this.self()}fontSize(e){return this._text.style.fontSize=e,this.self()}fontWeight(e){return this._text.style.fontWeight=e,this.self()}textAlign(e){return this._text.style.textAlign=e,this.self()}textAlignVertical(e){return this._text.style.textAlignVertical=e,this.self()}fillColor(e){return this._text.style.fillColor=e,this.self()}fillOpacity(e){return this._text.style.fillOpacity=e,this.self()}strokeColor(e){return this._text.style.strokeColor=e,this.self()}strokeOpacity(e){return this._text.style.strokeOpacity=e,this.self()}strokeWidth(e){return this._text.style.strokeWidth=e,this.self()}lineHeight(e){return this._text.style.lineHeight=e,this.self()}build(){return Object.assign(Object.assign({},this._item),{type:"TEXT",text:this._text})}}class vn extends gt{constructor(e){super(e),this._commands=[],this._fillRule="nonzero",this._style={fillColor:"black",fillOpacity:1,strokeColor:"white",strokeOpacity:1,strokeWidth:5,strokeDash:[]},this._item.name="Path",this._item.layer="DRAWING"}commands(e){return this._commands=e,this.self()}fillRule(e){return this._fillRule=e,this.self()}style(e){return this._style=e,this.self()}fillColor(e){return this._style.fillColor=e,this.self()}fillOpacity(e){return this._style.fillOpacity=e,this.self()}strokeColor(e){return this._style.strokeColor=e,this.self()}strokeOpacity(e){return this._style.strokeOpacity=e,this.self()}strokeWidth(e){return this._style.strokeWidth=e,this.self()}strokeDash(e){return this._style.strokeDash=e,this.self()}build(){return Object.assign(Object.assign({},this._item),{type:"PATH",commands:this._commands,fillRule:this._fillRule,style:this._style})}}const Ye=typeof Buffer=="function",it=typeof TextDecoder=="function"?new TextDecoder:void 0;typeof TextEncoder=="function"&&new TextEncoder;const Cn="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",In=Array.prototype.slice.call(Cn),Te=(t=>{let e={};return t.forEach((n,s)=>e[n]=s),e})(In),Sn=/^(?:[A-Za-z\d+\/]{4})*?(?:[A-Za-z\d+\/]{2}(?:==)?|[A-Za-z\d+\/]{3}=?)?$/,j=String.fromCharCode.bind(String),ot=typeof Uint8Array.from=="function"?Uint8Array.from.bind(Uint8Array):t=>new Uint8Array(Array.prototype.slice.call(t,0)),Bt=t=>t.replace(/[^A-Za-z0-9\+\/]/g,""),Nn=/[\xC0-\xDF][\x80-\xBF]|[\xE0-\xEF][\x80-\xBF]{2}|[\xF0-\xF7][\x80-\xBF]{3}/g,wn=t=>{switch(t.length){case 4:var e=(7&t.charCodeAt(0))<<18|(63&t.charCodeAt(1))<<12|(63&t.charCodeAt(2))<<6|63&t.charCodeAt(3),n=e-65536;return j((n>>>10)+55296)+j((n&1023)+56320);case 3:return j((15&t.charCodeAt(0))<<12|(63&t.charCodeAt(1))<<6|63&t.charCodeAt(2));default:return j((31&t.charCodeAt(0))<<6|63&t.charCodeAt(1))}},xn=t=>t.replace(Nn,wn),Ln=t=>{if(t=t.replace(/\s+/g,""),!Sn.test(t))throw new TypeError("malformed base64.");t+="==".slice(2-(t.length&3));let e,n="",s,i;for(let o=0;o<t.length;)e=Te[t.charAt(o++)]<<18|Te[t.charAt(o++)]<<12|(s=Te[t.charAt(o++)])<<6|(i=Te[t.charAt(o++)]),n+=s===64?j(e>>16&255):i===64?j(e>>16&255,e>>8&255):j(e>>16&255,e>>8&255,e&255);return n},Rt=typeof atob=="function"?t=>atob(Bt(t)):Ye?t=>Buffer.from(t,"base64").toString("binary"):Ln,Mn=Ye?t=>ot(Buffer.from(t,"base64")):t=>ot(Rt(t).split("").map(e=>e.charCodeAt(0))),Dn=Ye?t=>Buffer.from(t,"base64").toString("utf8"):it?t=>it.decode(Mn(t)):t=>xn(Rt(t)),bn=t=>Bt(t.replace(/[-_]/g,e=>e=="-"?"+":"/")),Gn=t=>Dn(bn(t));function Pn(){const e=new URLSearchParams(window.location.search).get("obrref");let n="",s="";if(e){const o=Gn(e).split(" ");o.length===2&&(n=o[0],s=o[1])}return{origin:n,roomId:s}}var h;(function(t){t[t.MOVE=0]="MOVE",t[t.LINE=1]="LINE",t[t.QUAD=2]="QUAD",t[t.CONIC=3]="CONIC",t[t.CUBIC=4]="CUBIC",t[t.CLOSE=5]="CLOSE"})(h||(h={}));const Ge=Pn(),N=new $t(Ge.origin,Ge.roomId),Un=new xt(N),ze=new wt(N),Vn=new On(N),kn=new Yt(N),Hn=new an(N),Fn=new dn(N),Wn=new un(N),$n=new ln(N),Yn=new hn(N),zn=new fn(N),jn=new En(N),Kn=new mn(N),Xn=new pn(N),Qn=new An(N),Zn=new Bn(N),W={onReady:t=>{N.ready?t():N.once("OBR_READY",()=>t())},get isReady(){return N.ready},viewport:Un,player:ze,party:Vn,notification:kn,scene:Hn,contextMenu:Fn,tool:Wn,popover:$n,modal:Yn,action:zn,interaction:jn,room:Kn,theme:Xn,assets:Qn,broadcast:Zn,isAvailable:!!Ge.origin};function Jn(){return new Rn(ze)}function qn(){return new vn(ze)}class ${static EXTENSIONID="com.battle-system.mark";static VERSION="whatsnew-mark-141";static LABELSID="com.battle-system.labels";static MARKCONNECT="com.battle-system.marked-connect";static DICENOTATION=/(\d+)[dD](\d+)(.*)$/i;static DICEMODIFIER=/([+-])(\d+)/;static PARENTHESESMATCH=/\((\d*d\d+\s*([+-]\s*\d+)?)\)/g;static PLUSMATCH=/\s(\+\d+)\s/g;static CHECKREGISTRATION="https://vrwtdtmnbyhaehtitrlb.supabase.co/functions/v1/patreon-check";static ANONAUTH="Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZS1kZW1vIiwicm9sZSI6ImFub24iLCJleHAiOjE5ODM4MTI5OTZ9.CRXP1A7WOeoJeXxjNni43kdQwgnWNReilDMblYTn_I0"}let Pe=!1;function os(){let t=new Date().getTime();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,n=>{const s=(t+Math.random()*16)%16|0;return t=Math.floor(t/16),(n==="x"?s:s&3|8).toString(16)})}function rs(t,e){const n=window.matchMedia("(prefers-color-scheme: dark)"),s=n.matches?"dark":"light",i=n.matches?"light":"dark";for(var o=0;o<e.styleSheets.length;o++)for(var r=0;r<e.styleSheets[o].cssRules.length;r++){let a=e.styleSheets[o].cssRules[r];a&&a.media&&a.media.mediaText.includes("prefers-color-scheme")&&(t.mode=="LIGHT"?(a.media.appendMedium(`(prefers-color-scheme: ${s})`),a.media.mediaText.includes(i)&&a.media.deleteMedium(`(prefers-color-scheme: ${i})`)):t.mode=="DARK"&&(a.media.appendMedium(`(prefers-color-scheme: ${i})`),a.media.mediaText.includes(s)&&a.media.deleteMedium(`(prefers-color-scheme: ${s})`)))}}function es(t,e){const n=rt(t),s=rt(e),i=ts(n,s);return ns(i)}function rt(t){const e=t.replace(/[^a-f0-9]/gi,""),n=[];for(let s=0;s<e.length;s+=2)n.push(parseInt(e.substring(s,2),16));return n}function ts(t,e){return[...t,...e]}function ns(t){const e=new Uint8Array(t),n=Array.from(e).map(i=>i.toString(16).padStart(2,"0"));return[n.slice(0,4).join(""),n.slice(4,6).join(""),n.slice(6,8).join(""),n.slice(8,10).join(""),n.slice(10).join("")].join("-")}function cs(t){var e=/^#?([a-f\d])([a-f\d])([a-f\d])$/i;t=t.replace(e,function(i,o,r,a){return o+o+r+r+a+a});var n=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t);if(n){var s=`(${parseInt(n[1],16)}, ${parseInt(n[2],16)}, ${parseInt(n[3],16)})`;return s}else return}function as(t){return`#${t.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/).slice(1).map(e=>parseInt(e,10).toString(16).padStart(2,"0")).join("")}`}function ss(t,e){const n=e/t.grid.dpi,s=t.image.width*n*t.scale.x,i=t.image.height*n*t.scale.y,o=t.grid.offset.x/t.image.width*s,r=t.grid.offset.y/t.image.height*i,a={x:t.position.x-o,y:t.position.y-r},l={x:a.x+s,y:a.y+i};return{min:a,max:l}}function ds(t){return t?/^#?([0-9A-Fa-f]{3}|[0-9A-Fa-f]{6})$/.test(t):!1}function us(){const t=document.createElement("img");return t.id="PatreonButton",t.setAttribute("class","icon"),t.classList.add("clickable"),t.setAttribute("title",Pe?"Thanks for subscribing!":"Get the news on updates on the Battle-System Patreon"),t.setAttribute("src",Pe?"w-thankyou.svg":"/w-patreon-2.png"),t.onclick=async function(e){e.preventDefault(),window.open("https://www.patreon.com/battlesystem","_blank")},t}async function ls(){const t=await W.player.getId();try{const e=window.location.origin.includes("localhost")?"eternaldream":"",n={owlbearid:t},s={method:"POST",headers:new Headers({"Content-Type":"application/json",Authorization:$.ANONAUTH,"x-manuel":e}),body:JSON.stringify(n)},i=await fetch($.CHECKREGISTRATION,s);if(!i.ok){const r=await i.json();console.error("Error:",r);return}(await i.json()).Data==="OK"?Pe=!0:console.log("Not Registered")}catch(e){console.error("Error:",e)}}class hs{static async UpdateLabel(e,n,s,i,o){const r=await W.player.getColor(),a=await W.scene.items.getItems(d=>d.attachedTo===e.id&&d.type==="TEXT"&&d.metadata[`${$.EXTENSIONID}/direction`]===c(n.Direction)),l=a.find(d=>d.text.plainText===n.Name);o===void 0?l?await W.scene.items.deleteItems([l.id]):await u():o===!0?l||await u():o===!1&&l&&await W.scene.items.deleteItems([l.id]);async function u(){let d=0,_=0;if(a.length>0){const x=await W.scene.items.getItemBounds([a[0].id]);_=x.max.y-x.min.y;for(let P=0;P<a.length+1;P++){let J=!1;if(J=a.some(f=>f.metadata[`${$.EXTENSIONID}/place`]===P),!J){d=P;break}}}const I=await W.scene.grid.getDpi(),g=ss(e,I),v=es(e.id,n.Id),S="#242424",R=parseInt(s),C=R+"px Roboto",y=+i/100,A=St(n.Name,C),H=Nt("AjTg",C),G={};G[`${$.EXTENSIONID}/place`]=d,G[`${$.EXTENSIONID}/comboid`]=v,G[`${$.EXTENSIONID}/direction`]=c(n.Direction);const E=Jn().fillColor(n.Color).plainText(n.Name).fillOpacity(y).strokeWidth(1.75).strokeColor("black").strokeOpacity(1).build();E.position={x:e.position.x,y:e.position.y},E.attachedTo=e.id,E.visible=!!e.visible,E.locked=!0,E.metadata=G,E.disableAttachmentBehavior=["ROTATION","SCALE"],E.type="TEXT",E.text.type="PLAIN",E.text.style.fontWeight=600,E.text.style.fontSize=R,E.text.style.textAlign="CENTER",E.text.style.fontFamily="Roboto",n.Direction=="Top"&&(E.position.x-=A/2,E.position.y=g.min.y-(H+20),a.length>0&&d!==0&&(E.position.y-=_*d)),n.Direction=="Bottom"&&(E.position.x-=A/2,E.position.y=g.max.y-H/2+45,a.length>0&&d!==0&&(E.position.y+=_*d)),n.Direction=="Right"&&(E.position.x=g.max.x+15,E.position.y-=H/2,a.length>0&&d!==0&&(E.position.y+=_*d)),n.Direction=="Left"&&(E.position.x=g.min.x-15,E.position.x-=A+15,E.position.y-=H/2,a.length>0&&d!==0&&(E.position.y-=_*d)),await W.scene.items.addItems([E]);const je=await W.scene.items.getItems(x=>x.metadata[`${$.EXTENSIONID}/comboid`]===v),vt=await W.scene.items.getItemBounds(je.map(x=>x.id)),Ct=It(vt,n.Direction),_e=qn().commands(Ct).strokeOpacity(1).strokeWidth(4).strokeColor(r).fillOpacity(y).fillColor(S).build();_e.attachedTo=je[0].id,_e.disableHit=!0,_e.disableAttachmentBehavior=["ROTATION","SCALE"],await W.scene.items.addItems([_e]);function It(x,P){const J=x.max.y-x.min.y,f=x.min.x-10,T=x.max.x+10,O=x.min.y,m=O+J,p=Math.abs(m-O)/2,q=T-f,ee=10;return d!==0&&(P==="Top"||P==="Bottom")?[[h.MOVE,f+p,O],[h.QUAD,f,O,f,O+p],[h.LINE,f,m-p],[h.QUAD,f,m,f+p,m],[h.LINE,T-p,m],[h.QUAD,T,m,T,m-p],[h.QUAD,T,O,T-p,O],[h.CLOSE]]:P==="Top"?[[h.MOVE,f+p,O],[h.QUAD,f,O,f,O+p],[h.QUAD,f,m,f+p,m],[h.LINE,f+q/2-ee,m],[h.LINE,f+q/2,m+ee],[h.LINE,f+q/2+ee,m],[h.LINE,T-p,m],[h.QUAD,T,m,T,m-p],[h.QUAD,T,O,T-p,O],[h.CLOSE]]:P==="Bottom"?[[h.MOVE,f+p,O],[h.QUAD,f,O,f,O+p],[h.QUAD,f,m,f+p,m],[h.LINE,T-p,m],[h.QUAD,T,m,T,m-p],[h.QUAD,T,O,T-p,O],[h.LINE,f+q/2+ee,O],[h.LINE,f+q/2,O-ee],[h.LINE,f+q/2-ee,O],[h.CLOSE]]:P==="Left"?[[h.MOVE,f+p,O],[h.QUAD,f,O,f,O+p],[h.LINE,f,m-p],[h.QUAD,f,m,f+p,m],[h.LINE,T-p,m],[h.QUAD,T,m,T,(m+O)/2+5],[h.LINE,e.position.x,e.position.y],[h.LINE,T,(m+O)/2-5],[h.QUAD,T,O,T-p,O],[h.LINE,f+p,O],[h.CLOSE]]:[[h.MOVE,f+p,O],[h.QUAD,f,O,f,(m+O)/2-5],[h.LINE,f,(m+O)/2-5],[h.LINE,e.position.x,e.position.y],[h.LINE,f,(m+O)/2+5],[h.QUAD,f,m,f+p,m],[h.LINE,T-p,m],[h.QUAD,T,m,T,m-p],[h.QUAD,T,O,T-p,O],[h.CLOSE]]}function St(x,P){const f=document.createElement("canvas").getContext("2d");if(!f)throw new Error("Canvas 2D context is not supported.");return f.font=P,f.measureText(x).width}function Nt(x,P){const f=document.createElement("canvas").getContext("2d");if(!f)throw new Error("Canvas 2D context is not supported.");f.font=P;const T=f.measureText(x);return T.actualBoundingBoxAscent+T.actualBoundingBoxDescent}}function c(d){switch(d){case"Top":return 601;case"Bottom":return 602;case"Right":return 603;case"Left":return 604;default:throw new Error("Invalid direction")}}}}export{$ as C,us as G,cs as H,hs as L,W as O,as as R,rs as S,ls as a,os as b,ds as i};
